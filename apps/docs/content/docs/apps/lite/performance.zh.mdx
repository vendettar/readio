---
title: 性能指南
---

# 性能指南

Readio 是一个音频应用程序。
**目标**: 音频播放绝不能卡顿，且 CPU 使用率必须极低以节省电量。

---

## 1. 电池节能 ("隐藏"规则)

**规则**: 当标签页不可见时暂停非必要工作。
- **机制**: 使用 `document.hidden` 或 `Page Visibility API`。
- **优化**:
  - 如果标签页被隐藏，停止更新逐字稿活动行高亮。
  - 减慢 UI 轮询/刷新间隔。
  - 当 `visibilitychange` 触发时立即恢复。

## 2. 内存管理 (撤销规则)

**规则**: 每个 `URL.createObjectURL()` 必须有对应的 `URL.revokeObjectURL()`。

- **音频 Blob**: Object URL 必须由 Store 统一创建与回收（如 `playerStore.loadAudioSource(blob)`）；组件不得为音频调用 `URL.createObjectURL`。
- **图片 Blob**: 组件必须为封面创建 Object URL，并在卸载时回收（例如 `useImageObjectUrl`）。
- **验证**: 如果每次切歌后内存使用量增加，则说明发生了 Object URL 泄漏。

## 3. 列表虚拟化

**规则**: 任何可能增长 > 50 项的列表必须虚拟化。
- **工具**: `react-virtuoso`。
- **场景**:
  - 播客剧集列表。
  - 文件资源管理器 (文件夹/轨道)。
  - 逐字稿视图 (每一行都是一个虚拟项)。

**反模式**: 在大数组上渲染 `array.map()`。这会阻塞主线程并冻结音频 UI。

## 4. 图像优化

**规则**: 延迟加载所有不在视口中的图像。
- **组件**: 使用带有 `loading="lazy"` 的标准 `img`。
- **解码**: 使用 `decoding="async"` 防止图像解码阻塞主线程。

## 5. 重新渲染卫生

**规则**: 音频播放器组件 (进度条, 计时器) 每秒更新。
- **隔离**: 将快速变化的状态隔离到小的叶子组件 (`ProgressBar`, `CurrentTime`)。
- **避免**: 不要让高频更新触发整个 `Player` 或 `Page` 的重新渲染。
- **技术**: 使用 Zustand 原子选择器 (`usePlayerStore(s => s.progress)`)。

## 6. 根布局卫生

**规则**: 根布局 (`__root.tsx`) 绝不能订阅高频状态更改。
- **为什么**: 如果 Root 重新渲染，整个 React 树都会重新渲染。
- **修复**: 将事件监听器和高频逻辑移动到隔离的、记忆化的组件中 (例如，`<GlobalAudioController />`)。

## 7. 事件监听器清理

**规则**: 所有全局事件监听器 (`window.*`, `document.*`) 必须在 `useEffect` 返回块中清理。
- **标准**: 优先使用 `react-hotkeys-hook` 和 `@use-gesture`，它们内部处理清理。

## 8. 繁重计算 (Web Workers)

**规则**: 解析大文件 (例如，50MB RSS XML，大型 SRT 字幕) 必须在 Web Worker 中发生。
- **阻塞**: 任何耗时 > 50ms 的函数对于主线程来说都太慢了，会导致音频故障。

## 9. 交互延迟 (异步处理程序)

**规则**: 永远不要在没有立即 UI 反馈的点击处理程序中执行 `await`。
- **场景**: 点击需要获取数据才能播放的搜索结果。
- **Bad**: 用户点击 -> 2秒内没反应 -> 音频播放。
- **Good**: 用户点击 -> **立即显示 Spinner/禁用状态** -> 获取 -> 音频播放。

## 10. 数据库索引 (Dexie)

**规则**: 永远不要使用 `.filter()` 搜索大表。
- **为什么**: 这会触发全表扫描 (O(N))，将所有记录读入内存。
- **修复**: 使用 IndexedDB 索引和索引字段上的 `.startsWithIgnoreCase()` 或 `.equals()`。

---

## 计划中（待执行）

- **包体积预算**：在 CI 中强制 gzip 体积上限（指令 050）。
- **PWA 音频 Range 缓存**：离线 seek 支持 206（指令 060）。
- **内存压测**：长会话 profiling 与堆快照检查（指令 061）。
- **异步竞态审计**：保证最后一次点击生效（指令 068）。
- **媒体缓存淘汰**：音频 blob LRU 淘汰策略（指令 072）。
- **事件监听泄漏审计**：统一全局监听清理（指令 080）。
