---
title: Coding Standards
---

# Engineering & Coding Standards

## 1. Multi-Media & OS Integration

### Media Session API (The OS Sync Rule)
**Rule**: The App's playback state MUST sync with the Operating System's media center.
- **Sync**: Title, Artist, and Artwork must be updated via `navigator.mediaSession.metadata`.
- **Control**: Play, Pause, Seek, and Skip actions must be mapped to `navigator.mediaSession.setActionHandler`.
- **Result**: Users should be able to control Readio from their Lock Screen, Keyboard keys, and Menu bar.

### Player State Machine Rule
**Rule**: The UI state MUST strictly follow the hardware `<audio>` state.
- **Enums**: Prefer a `status` enum (`idle`, `loading`, `playing`, `paused`, `error`) over multiple booleans.
- **Reverse Sync**: The UI `isPlaying` state must be updated by the audio element's `onPlay` and `onPause` events, not just the user's click.
- **Error Handling**: If `audio.play()` fails (Autoplay block), the UI must revert to `paused`.

## 2. Internationalization & RTL

### Logical Properties (RTL Rule)
**Rule**: NEVER use physical direction classes (`ml-`, `mr-`, `pl-`, `pr-`, `left-`, `right-`).
**Requirement**: Use Logical Properties to ensure UI correctly mirrors for Right-to-Left (RTL) languages (Arabic, Hebrew).
- `ml-*` -> **`ms-*`** (Margin Start)
- `mr-*` -> **`me-*`** (Margin End)
- `pl-*` -> **`ps-*`** (Padding Start)
- `pr-*` -> **`pe-*`** (Padding End)
- `text-left` -> **`text-start`**
- `border-l` -> **`border-s`**

### Date & Number Formatting
**Rule**: Use `Intl` API or `date-fns` with locale objects for all user-facing dates and numbers. Never manually split date strings.

## 3. React & Hooks

- **Focus Management**:
  - Use `autoFocus` prop and library callbacks (`onCloseAutoFocus`).
  - Do not use `setTimeout` hacks.

- **Effect Dependencies**:
  - Be exhaustive with `useEffect` dependencies.
  - Handle "late binding" for refs (e.g., Audio element) correctly.

- **Zustand & Persistence**:
  - Keep store logic pure and typed.
  - Use explicit selectors to prevent unnecessary re-renders.
  - **Persistence**: Prefer explicit `loadFromDB()` / `saveToDB()` actions (using `src/lib/dexieDb.ts`) over `zustand/persist`.
  - **Dexie Versioning**: Use a single schema version only. If schema changes, reset local data.

## 4. Data Fetching Strategy

- **Proxy Fallback**:
  - Use `fetchWithFallback` from `src/lib/fetchUtils.ts`.
  - Implements: Direct → Primary Proxy → Secondary Proxy.

- **Deduplication**:
  - Use `deduplicatedFetch` from `src/lib/requestManager.ts` for read-only GET requests.

- **Cancellation**:
  - Always pass `AbortSignal`.
  - Use `abortRequestsWithPrefix` for cleaning up requests when switching views.

## 5. Architecture & Consistency

### A. External Input Validation
- **Rule**: All external inputs (RSS/Search/Drag&Drop) must pass through Zod schema (`safeParse`).
- **Implementation**: Use `src/lib/schemas/*`.

### B. Form Handling (Standard)
- **Rule**: Do NOT use manual `useState` for complex forms or settings.
- **Library**: **`react-hook-form`** + **`zod`**.
- **Usage**: Use Shadcn's `<Form>` components to wrap the logic. Ensure all inputs are registered.

### C. File Handling (Standard)
- **Rule**: Do NOT use manual drag/drop event listeners for file ingestion.
- **Library**: **`react-dropzone`**.
- **Implementation**: Use the `useDropzone` hook to manage states (`isDragActive`, `acceptedFiles`).

### D. Shared Cache Policy
- **Rule**: Cache read/write must use unified `storage` utilities (`getJsonWithTtl`).

### E. Error Handling Tiers
| Tier | Trigger | Action |
|------|---------|--------|
| **User Error** | Operation failure | Toast / Empty State (i18n) |
| **System Error** | Parse failure | `console.warn/error` (silent) |

### F. Type-Safe I18n
- **Rule**: All translations must use **`react-i18next`**.
- **Typing**: `t()` function must be type-checked against English keys (see `i18n-guide.md`).

## 6. Testing Standards (The Pyramid)

- **Framework**: Vitest.
- **Store Testing**: Reset store state in `beforeEach`.

## 7. Files & Structure

- **`src/lib`**: Centralize business logic (`storage.ts`, `dateUtils.ts`).
- **`src/components/ui`**: Reserved for shadcn primitives.
- **`src/components/interactive`**: Custom interaction primitives.

---

## 8. Anti-Patterns (Right vs Wrong)

### A. Form State
❌ **Wrong**: Manual state
```tsx
const [name, setName] = useState('')
<input value={name} onChange={e => setName(e.target.value)} />
```
✅ **Right**: React Hook Form
```tsx
const form = useForm({ defaultValues: { name: '' } })
<FormField control={form.control} name="name" render={({ field }) => <Input {...field} />} />
```

### B. File Drop
❌ **Wrong**: Native listeners
```tsx
<div onDrop={e => handleFiles(e.dataTransfer.files)} />
```
✅ **Right**: React Dropzone
```tsx
const { getRootProps } = useDropzone({ onDrop })
<div {...getRootProps()} />
```

---

## 9. Defensive Engineering

### A. Layout Robustness (The Long-Text Rule)
**Rule**: NEVER assume text will be short.
- **Titles**: Always use `truncate` or `line-clamp-X`.
- **Containers**: Use `min-w-0` on flex items to ensure they don't push past parent boundaries.
- **Scroll**: Ensure overflow is handled (`overflow-hidden` or `overflow-y-auto`).

### B. Multi-Tab Singleton
**Rule**: Audio apps must be Singletons per browser.
- **Implementation**: Use a `BroadcastChannel` named `readio_playback`.
- **Action**: When tab A starts playing, send a "PLAY" message. All other tabs (B, C) MUST pause immediately.

### C. Graceful Degradation
- **Rule**: If a local file is missing from DB (e.g., deleted by browser cleanup), show an "File Missing" state instead of crashing.
