---
title: Search System
---

## Global Search Architecture (Global Search)

Search system as a global entry point, adopts a two-stage workflow:

### Stage 1: Palette (Command Palette)
- **Trigger**: Sidebar search trigger input or shortcut (`Cmd+K`).
- **Display**: Integrated sidebar `CommandPalette` component (`cmdk`) with premium glass effects.
- **Content**: Displays high-confidence Top Matches, limited to 5 items per type (Shows, Episodes, Local Files).
- **Status Indicator**: **Standardized Right-Aligned Badges**.

  - All status indicators (Subscribed, Favorited, History, File) use a unified visual language: right-aligned, vertically centered, and `text-primary` color (Decision D053).
  - **Multi-State Merging**: If an item matches multiple criteria (e.g., it is both Favorited and in History), **ALL** relevant icons must be displayed side-by-side. Deduplication logic must merge metadata rather than overriding it.
  - Replaces previous "StatusBadge" chip component to reduce visual noise.

### Stage 2: Results Page (Full Search Page)
- **Trigger**: Enter key or click "View all results".
- **Route**: `/search?q=query`.
- **Responsibility**: Comprehensively display all matches, support pagination.

### Core Behaviors
- Search is an independent content retrieval system, not an in-page filter.
- Results grouped by content type, user relationships as metadata tags (Badges).
- `âŒ˜K` (meta+K) as global shortcut.

### Offline Behavior (Required)
- When `isOnline` is false, **hide remote results** and keep local results only.
- Remote search should not execute; surface local matches without delay.
- **Local Entry**: Show a clear "Local Only" group (Subscriptions/Favorites/History/Files) to avoid empty UI.
- **Network Jitter**: Debounce online/offline changes and avoid repeated error toasts during rapid flaps.
- **Cache Miss**: If remote data is unavailable while offline, keep local-only mode without retry loops.

### Performance & Data Consistency Standards
- **Load Order**: Any search scenario (Search Overlay, Full Search Page, custom hooks) dependent on `subscriptions` / `favorites` in `useExploreStore` must call `loadSubscriptions()` / `loadFavorites()` before access. If not loaded successfully in store, fallback to Dexie query instead of directly assuming list is ready.
- **Real-time Refresh**: Search results must subscribe to `useExploreStore` state changes (e.g., via selector + Zustand subscription), rather than reading `getState()` once on mount. If user performs favorite/unfollow operations during search, Overlay/Results Page needs to refresh tags instantly.
- **Unified Limit**: `useGlobalSearch(query, enabled, limits?)` controls unified upper limit for four types of local results (Subscriptions/Favorites/History/Local Files) at hook layer (default 5). Caller must not arbitrarily extend quantity at UI layer; if special case needed (e.g., Search Page displaying full list), `limits` override must be explicitly passed. This way Overlay / Spotlight / Results Page all share the same strategy.
- **Avoid Full Table Scan**: Local History (`playback_sessions`) and Local Files (`local_tracks`) tables can be very large; do not `getAll*()` full scan on every keystroke. `useGlobalSearch` uses Dexie's `searchPlaybackSessionsByTitle` / `searchFileTracksByName` combined with throttled reading of recent N items; new scenarios must follow same strategy (Index-based, Pagination or Worker), creating new full table scans is prohibited.
- **Result Caps**: Local results must be capped (Top N) in overlay mode. Full search page can raise limits explicitly.
- **Remote Throttle**: Remote search must debounce and cancel/ignore stale requests (use `AbortController` or requestId).
- **Index-Based Search**: Local searches on large tables (History, Local Tracks) must avoid table scans. Enforce `startsWithIgnoreCase` on indexed fields (`title`, `name`) for O(log N) performance.
- **Race Condition Protection**: Local Dexie search uses 200ms debounce + requestId invalidation mechanism; clearing query immediately clears results and prevents old request write-back, avoiding short-term "flashback of old results".
- **Consistent Action**: All Local results (subscription/favorite/history/file) must call `executeLocalSearchAction` to trigger behavior consistent with list pages (Direct play or locate to specific episode), instead of navigating to aggregate page for user to operate again.
- **Whole Row Click Ban**: All list items in SearchOverlay / Results Page etc., prohibited from wrapping the entire row (including description area) in the same `Link` or `Button`.
- **Title Only Navigation**: Clicking description area (desc) should not trigger navigation; only title (via `InteractiveTitle`) and cover art (via `Button asChild`) allow navigation.
- **State Fallback**: When Episode returned by iTunes Search/Lookup lacks `feedUrl`, Play/Favorite logic must try to supplement first (e.g., lookup again or parse from RSS); if `feedUrl` still cannot be obtained, change to jump to show detail page (`handleSelectEpisode`) or prompt error. Never write playback Session without feed metadata, otherwise History/Favorites will lose association with the show.
    - Note: When Overlay/Global Search accesses store data via `useGlobalSearch`, ensure `loadSubscriptions()` / `loadFavorites()` called at least once (can trigger on Search Overlay mount) to prevent `getState()` reading empty list.
