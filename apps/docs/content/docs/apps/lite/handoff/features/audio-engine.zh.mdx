---
title: Audio Engine
---

## 1. 播放能力与会话恢复

### 会话恢复机制

**策略**：播放进度通过 `playback_sessions` 表持久化，刷新页面后自动恢复。

- **Podcast 会话**：通过 `audioUrl` 索引查找上次的 session
- **本地文件会话**：通过 `localTrackId`（local_tracks.id）精确查找，避免同名文件跨文件夹冲突
- **Dexie Schema**: 单一版本（v1）定义当前全部表结构与索引，不维护历史版本。

**实现细节**：
- **本地文件播放**: `useLocalPlayback` 在播放时先设置 `sessionId`（格式：`local-track-{trackId}`），然后创建包含完整信息的 session（包括 audioId 用于 Last Played）
- **播客播放**: `setAudioUrl(..., metadata)` 将 episode metadata 写入 store，`useSession` 创建 session 时持久化到 `playback_sessions`
- **Session 恢复**: `useSession` 检查是否存在 sessionId，有则跳过；无则：
  1. **确定性守卫**：对于本地文件，先直接查询 `local-track-{trackId}` 是否存在，存在则直接复用
  2. 否则通过 `localTrackId` 或 `audioUrl` 索引查找
  3. 都未找到才创建新 session
- **防止竞态**: 先设置 sessionId + 确定性 ID 查询，完全消除重复创建风险
- **历史删除语义**：
  - 删除 History 项仅移除 `playback_sessions` 记录（进度 + 最近播放）。
  - **不得**删除底层本地音频文件；文件仅由 Files 区域管理。

### 播放器基础能力

- **音频播放**：HTML5 `<audio>` 元素在 `__root.tsx` 中挂载，跨路由持久化
- **媒体会话**：`GlobalAudioController` 中的 `useMediaSession` 更新 `navigator.mediaSession` 元数据（标题/播客标题/封面）并注册系统控制动作（播放/暂停/上一条/下一条/快退/快进/跳转）。
- **播放速率控制**: 0.8x ~ 2.0x，通过 `playerStore.playbackRate` 管理，持久化通过 `storage.ts` 的 `setJson` 写入 localStorage。FullPlayer 读取 store 状态并提供速率切换按钮。
- **音量控制**：0-1 范围，通过 `storage.ts` 持久化到 localStorage（`usePlayerStore`）
- **进度控制**：Slider 直接调用 `seekTo()` 接口，用户拖拽结束后统一 seek
- **本地文件播放**：Blob URL 临时挂载，`< 300MB` 的音频缓存到 IndexedDB 支持离线恢复
- **播客元数据**：`setAudioUrl` 可接收 EpisodeMetadata（description/podcastTitle/feedUrl/artworkUrl/publishedAt），并写入 `playerStore.episodeMetadata` 供 History/Favorites 展示
- **快速切换稳态**：快速 Play/Pause 或跨曲目切换时，最终必须收敛到最后一次操作，且不出现卡死 `loading`。
- **播放器状态机**：状态严格管理为 `idle | loading | playing | paused | error`。
  - **状态转换**：
    - Loading → (`canplay` 事件) → `playing` (如果 `isPlaying` 为 true) 或 `paused`。
    - `play()` → 设置 `isPlaying: true` 并将状态设为 `playing`。
    - `pause()` → 设置 `isPlaying: false` 并将状态设为 `paused`。
    - 错误 → 将状态设为 `error`。
  - **自动播放策略**：被浏览器拦截的自动播放（`NotAllowedError`）会在 `GlobalAudioController` 中捕获，静默回退到 `paused` 状态，并弹出 `player.autoplayBlocked` 提示。
- **单元测试**：在 `playerStore.test.ts` 和 `GlobalAudioController.test.tsx` 中有严格测试，确保状态转换和资源清理（撤销 Object URL）无回归。
- **睡眠定时器**：
  - 由 `useSleepTimerStore` 和 `useSleepTimer` 钩子管理。
  - 选项：15分钟、30分钟、单集结束。
  - 倒计时逻辑封装在 `useSleepTimerStore` 中，以确保跨组件的单例计时器一致性。
  - 计时结束或单集播放结束后自动回退到 `paused` 状态。

---

## 2. Transcript（字幕渲染约束与虚拟列表）

产品要求：
- **字幕每个单词都可见**（多行显示，不做省略号截断）。

当前实现：
- 使用 `react-virtuoso` 实现动态高度虚拟列表。
- 移除了固定行高约束和文本截断。
- CSS 改为 `word-wrap: break-word; overflow-wrap: break-word; line-height: 1.5`，支持多行显示。
- **Zoom 支持**：通过 `useEffect` 监听 `zoomScale` 变化并触发 Virtuoso 重新测量。

实现细节：
- 组件：`src/components/Transcript/TranscriptView.tsx`
- FullPlayer 中也使用相同的 TranscriptView
- Following 模式：使用 `virtuosoRef.scrollToIndex()` 自动滚动到当前字幕行，居中对齐

### Selection（选词/查词）

- UI 组件：`src/components/Selection/SelectionUI.tsx`（ContextMenu / LookupPopover / hover overlay）
- 用户可见错误信息使用 i18n：查词失败等通过 `TranslationKey`（如 `lookupNotFound`）映射为 `t(key)` 文案
- 动态定位：仅使用 `left/top` 或 CSS 变量注入来表达动态布局，避免在 `style={{...}}` 中直接写 `width/height/transform`
