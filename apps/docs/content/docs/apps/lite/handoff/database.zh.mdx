---
title: Database & Persistence
---

## 持久化与缓存（Dexie IndexedDB）

使用 Dexie.js 封装 IndexedDB，默认数据库名为 `readio-lite`，可通过 `READIO_DB_NAME` 覆盖（如清库时使用临时名称）。

### 身份 vs 去重（硬规则）
- **身份**：所有持久化实体使用 UUID 作为主键。
- **去重**：`feedUrl` 与复合 `key` 仅用于去重/查询，不得作为实体身份或 UI key。

### 数据库 Schema

| Store | Primary Key | Unique Indexes | 用途 |
|-------|-------------|---------|------|
| sessions | id (UUID) | title (index), &trackId | 播放会话（进度、音频/字幕 ID） |
| audioBlobs | id (UUID) | — | 本地音频文件 Blob |
| subtitles | id (UUID) | — | 本地字幕文件内容 |
| folders | id (UUID) | createdAt | 本地文件夹 |
| local_tracks | id (UUID) | name (index), folderId, createdAt | 本地音乐库音轨（链接 audioBlobs） |
| local_subtitles | id (UUID) | trackId | 本地音乐库字幕（链接 subtitles） |
| subscriptions | id (UUID) | &feedUrl | 订阅的播客。feedUrl 用于去重检查。 |
| favorites | id (UUID) | &key | 收藏的节目。key 用于去重检查。 |
| settings | key | — | 用户设置（如 country） |

### 会话硬化（防止进度丢失与时间戳污染 / Session Hardening）

为防止在重新创建固定会话 ID（例如 `local-track-${id}`）时意外覆盖现有播放会话，请使用 `DB.upsertPlaybackSession(data)`。该辅助方法会合并字段，并保留现有的 `progress`、`duration` 和 `lastPlayedAt`，除非在 `data` 中显式提供。

**时间戳逻辑**：`DB.updatePlaybackSession` 不再自动更新 `lastPlayedAt`。时间戳仅在播放器处于活跃的 `isPlaying` 状态时由 Store 更新。这确保了打开应用（恢复会话）或在暂停时跳转进度不会通过将回话推至列表顶部来“污染”历史记录。

### 数据保留策略 (Retention Policy) [已实现]

为防止 IndexedDB 无限制增长，所有播放历史均受自动保留策略约束：
- **限制条件**：保留最新的 **1000** 条会话 **或** 最近 **6 个月** 的记录，以限制更严格（更小）者为准。
- **触发机制**：在应用启动时的后台任务中运行（参见 `retention.ts`）。
- **批处理**：删除操作分批进行（如每批 100 条），批次间有微小延迟，以确保启动时的 UI 响应性。

### 重置策略

重置策略允许清库重建，不包含迁移兼容层。
- **默认 DB 名**：禁止在源码中修改默认数据库名；清库请用 `READIO_DB_NAME` 覆盖或 `clearAllData()`。
- **清理方式**：`clearAllData()` 使用表级清空而非删除数据库，保持 DB 实例可用。
**Dexie 版本策略**：仅保留单一版本（v1）定义，不维护历史版本或升级路径。未来 schema 变更直接清库重建；不要递增 version 号。

### Personal Vault（元数据导出/导入）[已实现]
- **格式**：顶层包含 `version` 与 `exportedAt`。
- **范围**：仅元数据表（folders、tracks、subscriptions、favorites、history、settings），不包含音频/字幕 blob。
- **校验**：导入时使用 Zod 校验结构。
- **逻辑**：事务内执行，导入会覆盖现有元数据。
- **必须**：导入前要求用户确认（对话框）。
- **警告**：导入是破坏性的，**不可回滚**。

### OPML 导入/导出 [已实现]
- **导入**：递归解析 OPML（`outline` 节点），提取 `xmlUrl` + `title`。
- **去重**：根据 `feedUrl` 唯一索引跳过已存在订阅。
- **存储**：写入订阅使用 UUID 主键。
- **导出**：生成 OPML 时对 `title` 与 `xmlUrl` 做 XML 属性转义。

---

## 计划中（待执行）

- **导入完整性校验**：解析后校验 ID 与引用关系（指令 049）。
- **离线缓存清理**：安全移除未引用的 blob（指令 053）。
- **媒体缓存淘汰**：音频 blob LRU 淘汰策略（指令 072）。
- **存储配额监控**：在 Settings 显示配额使用情况（指令 074）。
- **IndexedDB 迁移**：版本化升级（指令 064）。
- **原子写入防护**：事务化写入与启动修复（指令 067）。
- **崩溃模拟验证**：中断写入后恢复检查（指令 067）。
