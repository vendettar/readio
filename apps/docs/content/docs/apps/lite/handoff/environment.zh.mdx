---
title: Development Environment
---

## 0. 前置要求 (Engines)

为确保环境一致性，我们通过 `package.json` 中的 `engines` 字段和 `.npmrc` 中的 `engine-strict=true` 强制执行工具版本：

- **Node.js**: `>=20.0.0`
- **pnpm**: `>=10.28.0`

如果本地环境不符合要求，执行 `pnpm install` 将报错。

## 1. 本地开发 / 构建 / 测试

构建与测试脚本（根目录下执行）：`pnpm build`、`pnpm test`、`pnpm --filter @readio/lite test:run`、`pnpm --filter @readio/lite test:e2e`。
代码质量工具：Biome（`pnpm lint`、`pnpm format`）。

### 标准依赖

以下库构成 **Phase 1 基准** — 它们已预安装，可供 Phase 2+ 重构使用：

| 类别 | 库 | 用途 |
|------|-----|------|
| **日期** | `date-fns` | 日期格式化与计算。禁止手动解析。 |
| **国际化** | `i18next`, `react-i18next`, `i18next-browser-languagedetector` | 国际化框架（待全面迁移）。 |
| **表单** | `react-hook-form`, `@hookform/resolvers`, `zod` | 表单状态管理与 Zod 校验。 |
| **文件拖放** | `react-dropzone` | 标准文件拖放区处理。 |
| **通知** | `sonner` | 现代 Toast 通知（待从 Radix Toast 迁移）。 |
| **动画** | `framer-motion` | 生产级动画库。 |
| **热键** | `react-hotkeys-hook`, `@use-gesture/react` | 键盘快捷键与手势处理。 |

### PWA 与原生分享 [已实现]

Readio 已配置为高质量 PWA：
- **Manifest**：`public/manifest.json` 定义 standalone 展示、主题色与图标。
- **iOS 加固**：`index.html` 包含 Apple 相关 meta（`apple-mobile-web-app-capable`、`apple-touch-icon`）。
- **原生分享**：`src/components/Player/ShareButton.tsx` 使用 `navigator.share`，桌面端使用剪贴板回退。

### 部署 [已实现]

Readio 支持通过 Vercel 进行自动化部署，并支持通过 Docker 进行手动私有化部署。

#### 内容安全策略 (CSP)
Readio 通过 **服务器/边缘层** 的 HTTP 响应头强制 CSP（不使用 `index.html` 中的 `<meta>` 标签）：
- **指令**: `default-src 'self'`, `script-src 'self'`, `style-src 'self' 'unsafe-inline'`, `img-src 'self' data: blob: https:`, `media-src 'self' blob: https:`, `connect-src 'self' https:`, `font-src 'self' data: https:`, `frame-ancestors 'none'`, `base-uri 'self'`。
- **说明**: 允许 `unsafe-inline` 样式以支持动态主题颜色和 UI 组件库动画。允许 `connect-src` 和 `img-src` 使用 `https:` 协议，以支持用户配置的自定义代理和远程封面。

落地位置：
- **Vercel**：在 `vercel.json` 中设置 `Content-Security-Policy` 响应头。
- **Docker (Nginx)**：在 `nginx.conf` 中通过 `add_header ... always;` 设置 `Content-Security-Policy` 响应头。

#### Vercel (默认)
- **配置**: 仓库根目录下的 `vercel.json`。
- **构建命令**: `pnpm --filter @readio/lite build`
- **输出目录**: `apps/lite/dist`
- **SPA 路由**: 强制重写规则将所有路径重定向至 `index.html`。
- **环境变量**:
  - `READIO_DB_NAME`: (可选) 覆盖默认 IndexedDB 名称。
  - `READIO_RSS_FEED_BASE_URL`: (可选) RSS 代理基础 URL。
  - `READIO_DISCOVERY_SEARCH_URL`: (可选) iTunes 搜索 API 端点。

#### Docker (私有化部署)
- **镜像**: 仓库根目录下的 `Dockerfile`，使用 `nginx:alpine`。
- **Nginx 配置**: `nginx.conf` 通过 `try_files` 处理 SPA 路由。
- **构建步骤**:
  1. `docker build -t readio-lite .`
  2. `docker run -p 8080:80 readio-lite`

### 计划中（待执行）
- CI 流水线（GitHub Actions，指令 044）。
- PWA 更新生命周期（指令 043）。
- PWA 音频 Range 缓存（指令 060）。
- 代理故障转移（指令 062）。
- 浏览器支持矩阵（指令 065）。
- Turborepo 缓存加固（指令 066）。
- Lighthouse CI 预算（指令 077）。
- 依赖审计与许可证策略（指令 078）。

### 测试策略

#### 单元测试（Vitest）

- 测试文件：`src/__tests__/*.test.ts`
- 使用 `fake-indexeddb` 模拟 IndexedDB
- 共 119 个测试用例
- 脚本：`pnpm --filter @readio/lite test:run` (从根目录执行)

#### E2E 测试（Playwright）

- 脚本：`pnpm --filter @readio/lite test:e2e` (从根目录执行)

---

## 2. Runtime Configuration (运行配置)

### 集中化配置 (`public/env.js`)

应用采用动态运行配置，而非仅依赖编译时环境变量：
- **文件**: `public/env.js` (由 `index.html` 直接引入)
- **职责**: 管理 API 地址 (iTunes, Dictionary)、存储限制 (Audio Max Size, Cache Limit)、UI 参数 (Zoom, Click Delay)。
- **默认值**: 包含生产环境默认值，可在部署环境注入覆盖值。

**存储缓存键**：
- `READIO_AUDIO_CACHE_MAX_MB`（默认 1024）
- `READIO_AUDIO_CACHE_TRIM_TARGET_MB`（默认 800）

### 配置访问 (`src/lib/runtimeConfig.ts`)

- `getAppConfig()` 提供类型安全的配置访问。它使用 Zod 强制转换（coercion）和默认值作为单一事实来源 (SSOT)，自动处理类型转换：
  - **String to Number**: `"123"` → `123`。
  - **Boolean Coercion**: 将 `"false"`、`"0"` 及任意未知字符串（如 `"trash"`）处理为 `false`；仅明确的 `"true"`/`"1"` 视为 `true`。
- `Window.__READIO_ENV__` 定义运行时配置结构。
- **词典 API 基地址**：使用 `READIO_DICTIONARY_API_URL`。查询 URL 通过 `new URL(word, base)` 构造，因此末尾 `/` 可选。

---

## 3. 常见排障

### 路由不生效

`src/routeTree.gen.ts` 由 Vite 插件在开发启动时生成。

### 数据库错误

默认数据库名为 `readio-lite`（清库时可通过 `READIO_DB_NAME` 覆盖），可在浏览器 IndexedDB 面板中查看与清理。

### Tailwind 样式不生效

PostCSS 管线使用 `@tailwindcss/postcss`（Tailwind v4）。

### 已知构建警告（Lightning CSS）

`pnpm --filter @readio/lite build` 目前会对 `::highlight(lookup-highlight)` 报告警告。这是 Lightning CSS 对 Highlights API 支持滞后导致的，等待工具链更新即可；不视为失败条件。
