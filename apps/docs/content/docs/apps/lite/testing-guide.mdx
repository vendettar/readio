---
title: Testing Guide
---

# Testing Guide

We use **Vitest** for unit and integration testing.

## 1. Mocking Dexie (IndexedDB)

Since Vitest runs in Node.js (JSDOM), IndexedDB is available via `fake-indexeddb` (setup in `vitest.setup.ts`).

However, for Unit Tests (e.g., testing a Hook), it is often better to **Mock the DB module** entirely to avoid state leakage.

```tsx
// Example: Mocking DB in a test
vi.mock('@/lib/dexieDb', () => ({
  DB: {
    files: {
      add: vi.fn(),
      toArray: vi.fn().mockResolvedValue([])
    }
  }
}))
```

## 2. Testing Stores (Zustand)

Zustand stores persist state between tests. You MUST reset them.

```tsx
import { usePlayerStore } from '@/store/playerStore'

const initialState = usePlayerStore.getState()

beforeEach(() => {
  usePlayerStore.setState(initialState, true) // true = replace
})
```

  const audio = document.querySelector('audio')!;
  Object.defineProperty(audio, 'currentTime', { get: () => 10, configurable: true });
  fireEvent.timeUpdate(audio);
  // Verify store.progress is now 10.
  ```

## 4. Hardware Mocks (Audio Engine)

Tests in `apps/lite/src/store/__tests__/playerStore.test.ts` and `apps/lite/src/components/AppShell/__tests__/GlobalAudioController.test.tsx` cover:
- **Status Enum Transitions**: `idle` -> `loading` -> `playing` | `paused`.
- **Resource Management**: Verification that `URL.revokeObjectURL` is called when switching tracks.
- **Autoplay Blocks**: Ensuring store reverts to correctly handled state if `audio.play()` rejects.
- **Feedback Loops**: Verifying that events from the `<audio>` element (timeupdate, durationchange) correctly update the centralized store.

## 4. Time-Based Tests

**Rule**: Never use `setTimeout` or real delays in tests.
- **Action**: Use `vi.useFakeTimers()`.
- **Scenario**: Testing the Sleep Timer. 
  - `vi.advanceTimersByTime(60000)` to simulate 1 minute passing.

## 5. What to Test?

- **Hooks**: Test the logic. e.g., `useFileHandler` should call `DB.add` when a file is dropped.
- **Utils**: Test edge cases. e.g., `formatDuration(0)` -> "00:00".
- **Components**: **Do NOT test** visual rendering unless it has complex conditional logic.

---

## Planned (Pending Execution)

- **MSW Network Mocks**: Replace manual mocks with MSW handlers for iTunes/RSS (Instruction 058).
