---
title: Decision Log
description: Architecture decisions and rationale.
---

# Architecture Decision Log

## D001 — UUID Primary Keys (All Tables)
- **Decision**: All tables use UUID primary keys; natural keys (e.g., `feedUrl`, `key`) are unique indexes only.
- **Rationale**: Global uniqueness, sync readiness, stable identity.
- **Implication**: Schema changes require DB reset (first‑release policy).

## D002 — I18n Direct Usage
- **Decision**: Components use `useTranslation()` from `react-i18next` directly; no `useI18n` adapter.
- **Rationale**: Standard API, fewer layers, clearer onboarding.

## D003 — Offline Strategy A
- **Decision**: When offline, hide remote Discovery and remote search results; keep local content available and show an Offline badge.
- **Rationale**: Predictable UX, no failing network calls.

## D004 — ObjectURL Ownership
- **Decision**: Audio Object URLs are store‑owned; image Object URLs are component‑owned with cleanup on unmount.
- **Rationale**: Prevent audio memory leaks while keeping UI flexibility for artwork.

## D005 — Deployment Target [Implemented]
- **Decision**: Primary deployment is Vercel; Docker is supported for self‑hosting.
- **Rationale**: Fast web deployment with a portable fallback.

## D006 — Legal Pages Required [Implemented]
- **Decision**: Privacy Policy and Terms of Service are mandatory for production.
- **Rationale**: Store compliance and user trust.

## D007 — Smoke E2E Tests [Implemented]
- **Decision**: Maintain Playwright smoke tests for core user journeys before release.
- **Rationale**: Prevent end‑to‑end regressions that unit tests miss.

## D008 — Strict CSP [Implemented]
- **Decision**: Enforce a strict Content Security Policy for all web deployments, via **HTTP response headers** (server/edge).
- **Rationale**: Reduce XSS and untrusted resource loading risk.

## D009 — Data Retention Policy [Implemented]
- **Decision**: Prune playback history to a bounded window (time + count).
- **Rationale**: Prevent long‑term IndexedDB bloat and performance degradation.

## D010 — PWA Update Lifecycle [Implemented]
- **Decision**: Notify users when a new PWA version is available and allow refresh.
- **Rationale**: Avoid stale clients and ensure users receive fixes.

## D011 — CI Pipeline [Implemented]
- **Decision**: Enforce lint/typecheck/tests on every PR via CI.
- **Rationale**: Prevent regressions from bypassing local checks.

## D012 — Import Integrity Checks [Implemented]
- **Decision**: Validate imports for ID collisions and broken references before writing to DB (Instruction 049).
- **Rationale**: Prevent silent corruption during Vault/OPML import.

## D013 — Bundle Size Budget [Implemented]
- **Decision**: Enforce bundle size budgets in CI (Instruction 050).
- **Rationale**: Prevent performance regressions from dependency bloat.

## D014 — Iframe Sandbox Policy
- **Decision**: Use strict iframe sandboxing for untrusted rich HTML when required.
- **Rationale**: Isolate untrusted content beyond DOMPurify.

## D015 — Feedback Loop
- **Decision**: Provide in-app links for bug reporting and support contact.
- **Rationale**: Close product feedback loop.

## D016 — Offline Content Visibility
- **Decision**: Show offline availability badges and provide cache cleanup tools.
- **Rationale**: Make offline behavior transparent and manageable.

## D017 — Episode Sorting & Filtering
- **Decision**: Provide sort/filter controls for episode lists.
- **Rationale**: Improve discoverability at scale.

## D018 — Content Attribution
- **Decision**: Show attribution and copyright complaint entry points.
- **Rationale**: Reduce legal exposure and clarify content ownership.

## D019 — Multilingual Typography
- **Decision**: Use language-specific font stacks.
- **Rationale**: Ensure consistent rendering across scripts.

## D020 — DB Access Guard
- **Decision**: Prevent direct DB access from UI components.
- **Rationale**: Enforce architecture boundaries.

## D021 — MSW for Network Tests
- **Decision**: Use MSW to mock external APIs in tests.
- **Rationale**: Stable and deterministic test runs.

## D022 — Contributing & Manifesto
- **Decision**: Document instruction-driven workflow and architecture manifesto.
- **Rationale**: Reduce onboarding friction and keep rules consistent.

## D023 — PWA Audio Range Cache
- **Decision**: Support Range Requests (206) in SW media cache for offline seeking.
- **Rationale**: Enable offline seek in large audio files.

## D024 — Memory Stress Test
- **Decision**: Maintain a long-session memory stress test for leak detection.
- **Rationale**: Prevent mobile crashes after hours of playback.

## D025 — Proxy Failover
- **Decision**: Support proxy list with automatic failover on 429/5xx.
- **Rationale**: Keep discovery resilient when a proxy fails.

## D026 — I18n Coverage Audit
- **Decision**: Enforce translation key parity across all languages at build time.
- **Rationale**: Prevent missing-key regressions in non-English locales.

## D027 — IndexedDB Migrations
- **Decision**: Move from reset-only policy to versioned migrations.
- **Rationale**: Preserve user data in production.

## D028 — Browser Support Matrix
- **Decision**: Define browserslist and legacy polyfill strategy.
- **Rationale**: Avoid white screens on older devices/WebViews.

## D029 — Turborepo Cache Hardening
- **Decision**: Explicit inputs/outputs for Turbo pipelines.
- **Rationale**: Ensure cache correctness and fast CI.

## D030 — Atomic Writes & Self-Heal
- **Decision**: Enforce transactional DB writes and boot-time integrity repair.
- **Rationale**: Prevent partial corruption on crashes/power loss.

## D031 — Async Race Condition Guard
- **Decision**: Use requestId/AbortController to ensure last-action-wins.
- **Rationale**: Avoid playback/UI desync under rapid interactions.

## D032 — Robust Metadata Parser (Phase 1)
- **Decision**: Use `music-metadata-browser` for ID3/M4A parsing.
- **Rationale**: Replaces filename-based heuristics with binary stream parsing to extract high-quality metadata (Artwork, Title, Duration).
- **Artwork Strategy**: Extract embedded covers, store as Blobs in Dexie, and serve via ephemeral `ObjectURL` in UI.
- **Implementation**: Currently main-thread. Worker migration (Phase 2) reserved for performance optimization if blocking becomes noticeable.


## D033 — Skeleton UI System
- **Decision**: Standardize shimmer-based skeletons for key surfaces.
- **Rationale**: Reduce layout shift and improve perceived performance.

## D034 — Overlay Layering Standardization
- **Decision**: Standardize Portal usage and z-index tokens without a global modal store.
- **Rationale**: Prevent stacking bugs while keeping local state intact.

## D035 — Media Cache Eviction
- **Decision**: Enforce LRU-based audio blob trimming with configurable limits.
- **Rationale**: Prevent uncontrolled storage growth.

## D036 — Network Backoff & Circuit Breaker
- **Decision**: Add exponential backoff and per-proxy circuit breaker.
- **Rationale**: Avoid retry storms and improve proxy resilience.

## D037 — Storage Quota Monitoring
- **Decision**: Surface quota usage and warnings in Settings.
- **Rationale**: Give users visibility before storage exhaustion.

## D038 — Intl API Upgrade
- **Decision**: Use Intl APIs for dates, numbers, and relative time.
- **Rationale**: Improve localization correctness and reduce manual formatting bugs.

## D039 — Granular Error Boundaries
- **Decision**: Add component-level error boundaries for critical UI nodes.
- **Rationale**: Prevent single-component crashes from taking down pages.

## D040 — Lighthouse CI Budget
- **Decision**: Enforce Lighthouse score budgets in CI.
- **Rationale**: Prevent regressions in performance and accessibility.

## D041 — Dependency Audit & License Policy
- **Decision**: Enforce vulnerability and license checks in CI.
- **Rationale**: Reduce supply-chain and compliance risk.

## D042 — Floating Promise Audit
- **Decision**: Require explicit error handling for async store actions.
- **Rationale**: Prevent silent failures and inconsistent state.

## D043 — Event Listener Leak Audit
- **Decision**: Standardize global listener management via a shared hook.
- **Rationale**: Avoid memory leaks under long sessions.

## D044 — Zustand Selector Optimization
- **Decision**: Enforce atomic selectors and `useShallow` for multi-select.
- **Rationale**: Reduce unnecessary re-renders.

## D045 — RSS Content CSS Isolation
- **Decision**: Isolate show-notes CSS via scoped reset (Shadow DOM fallback).
- **Rationale**: Prevent untrusted HTML from polluting UI.

## D046 — File Validation Strategy
- **Decision**: Layered approach for performance and security.
  - **Web (Lite)**: MIME type and extension validation only (UX focused).
  - **Backend**: Deep content validation (Magic numbers, full parsing).
  - **Native**: Decoder-based validation or lightweight head sniffing.
- **Rationale**: Keep client-side logic fast and lightweight while deferring intensive checks to secure environments.

## D047 — UI Pattern Change Gate
- **Decision**: Every modification to `ui-patterns/*.mdx` that introduces a new standardized interaction (e.g., standard forms, file drop zones) MUST be logged in the Decision Log.
- **Rationale**: Ensure architecture consistency and maintain a source of truth for UI standardization across the project (Instructions 012-015).

## D048 — Standardized File Drop Zone
- **Decision**: All file upload surfaces MUST use the `FileDropZone` component based on `react-dropzone` with Zod-based validation.
- **Rationale**: Provides consistent visual feedback (Glassmorphism), centralized error handling, and type-safe validation across the application (Instruction 015).

## D049 — Premium Glass Visuals
- **Decision**: Core structural surfaces (Sidebar, Player Footer, Overlays) MUST use Premium Glass materials (`backdrop-blur-xl`, `backdrop-saturate-150`, and `bg-background/80` or `bg-popover/95`).
- **Rationale**: Achieves a high-quality, native-like aesthetic that adapts to content and theme while maintaining legibility (Instruction 016).

## D050 — List Row Interactions
- **Decision**: All list items and cards MUST use `bg-accent/50` for hover states and `border-border/50` for separation, with "Smart Divider" logic (Instruction 016).
- **Rationale**: Maintains visual consistency across different list types and creates a focused, floating effect for interactive rows.

## D051 — Modern Toast Notifications (Sonner)
- **Decision**: Replace Radix Toast with `sonner` for all notification feedback.
- **Rationale**: Sonner provides superior developer experience (imperative API), better visual stacking, built-in promise support, and native-feeling animations (Instruction 017).

## D052 — Command Palette Search (cmdk)
- **Decision**: Replace custom floating Search Overlay with an inline sidebar `CommandPalette` based on `cmdk`.
- **Rationale**: Provides consistent keyboard navigation, improved accessibility, and a modern "inline sidebar search experience" that works globally (Instruction 018).

## D053 — Standardized Badge System
- **Decision**: All status indicators (Subscriptions, Favorites, History, Files, Listen Later) in lists and Command Palette MUST use a unified visual language: right-aligned, vertically centered, and `text-primary` color.
- **Rationale**: Ensures visual consistency and reduces cognitive load by establishing a predictable location and color for "Status" metadata across the application.

## D055 — Standardized Bits Animations
- **Decision**: Introduce a set of standardized, high-quality animation components (Bits) in `src/components/bits/`, starting with `AnimatedList` and `CountUp`.
- **Rationale**: Elevates the "vibe" and perceived quality of the application with fluid, premium motion patterns (Framer Motion) while ensuring reusability and architectural consistency (Instruction 021).
- **Implementation**:
    - `AnimatedList`: Staggered entrance animations for lists and grids.
    - `CountUp`: Smooth spring-based numeric transitions for statistics and usage values.

## D056 — Conditional "Last Played" Timestamp Update
- **Decision**: The `lastPlayedAt` timestamp in `PlaybackSession` is ONLY updated when `isPlaying` is true.
- **Rationale**: Prevents session restoration (e.g., reopening a tab) or manual seeking while paused from incorrectly bumping an item to the top of "Recent" lists. "Last Played" should semantically represent active consumption of content.
- **Implementation**:
    - Removed forced `Date.now()` in `DB.updatePlaybackSession`.
    - `playerStore` actions (`updateProgress`, `saveProgressNow`) conditionally include `lastPlayedAt` based on the current `isPlaying` state.

## D057 — Shared Element Transitions
- **Decision**: Use `layoutId` (Framer Motion) to synchronize persistent UI elements (especially artwork) between global UI states (MiniPlayer <-> FullPlayer).
- **Rationale**: Maintains spatial continuity, reduces visual pop-in, and achieves a high-end "native" feel.
- **Constraint**: The `layoutId` MUST be unique within the same visible tree. Conditional rendering (e.g., `isDesktop`) must be used if multiple nodes for different layouts (Mobile/Desktop) share the same semantic ID tracking the same object.

## D058 — App Boot Sequence
- **Decision**: Show a full-screen `BootLoader` (Breathing Logo) until all core IndexedDB stores are hydrated and the playback session is restored.
- **Rationale**: Prevents "Hydration Flash" (empty states briefly flickering) and provides a premium, native-app feel during cold starts.
- **Constraints**: 
    - Loader must use `fixed inset-0 z-50 bg-background` to perfectly cover content.
    - Transitions must use `AnimatePresence` for a smooth fade-out.

## D059 — Shared Element Transition Scoping
- **Decision**: If the same logical object appears multiple times on a single page, the `layoutId` MUST be scoped with a unique prefix (e.g., `sectionId`). Navigation to detail pages MUST pass this prefix via search parameters (`fromLayoutPrefix`) to enable context-aware target matching.
- **Rationale**: Prevents Framer Motion from becoming conflicted when duplicate content exists in different UI sections, resolving bugs where images disappear or components become unclickable during transitions.

## D060 — Logical Properties Migration (RTL Support)
- **Decision**: Migrate all physical CSS properties (`left`, `right`, `ml`, `mr`, `pl`, `pr`, `text-left`, `text-right`, `border-l`, `border-r`) to their logical equivalents (`start`, `end`, `ms`, `me`, `ps`, `pe`, `text-start`, `text-end`, `border-s`, `border-e`).
- **Rationale**: Enables seamless support for Right-to-Left (RTL) languages (e.g., Arabic, Hebrew) without duplicating CSS rules or using complex overrides. Aligns with modern web standards and improves future accessibility.
- **Constraint**: Directional icons must be explicitly flipped using `className="rtl:rotate-180"` where appropriate.

## D061 — Sleep Timer Architecture
- **Decision**: Centralize the sleep timer countdown ticker inside `useSleepTimerStore` (module-level interval), while `GlobalAudioController` remains responsible for reacting to end-of-episode events.
- **Rationale**: Guarantees a single ticker regardless of component mounting patterns, avoids duplicate timers, and keeps countdown state co-located with the store that owns it. The player should revert to a `paused` state when the timer expires.

## D062 — Tooltip Wrapping for Overlays
- **Decision**: Standardize wrapping `DropdownMenuTrigger` or `PopoverTrigger` with `Tooltip` for icon-only buttons that also provide transient state feedback (e.g., remaining sleep timer time). 
- **Rationale**: Adheres to the "Icon-only buttons MUST have a Tooltip" rule while allowing rich interaction on click.

## D063 — Image Fallback Strategy [Implemented]
- **Decision**: All artwork/images MUST use a standard fallback mechanism: themed skeleton (`bg-muted/50`) during loading, and a fallback icon (`Podcast` or `Disc`) on error. Transition between states MUST use a smooth fade. (Instruction 046)
- **Rationale**: Prevents "broken image" icons from degrading the premium aesthetic and ensures layout stability during content ingestion.

## D064 — Onboarding & Empty States [Implemented]
- **Decision**: All empty library/list views MUST use a standardized `EmptyState` pattern: centered orientation, high-quality icon, clear descriptive text, and a primary CTA button. (Instruction 045)
- **Rationale**: Reduces user abandonment by providing clear guidance on how to populate the application and ensuring the first-run experience is intentional.

