---
title: 决策日志
description: 架构决策与理由。
---

# 架构决策日志

## D001 — UUID 主键（所有表）
- **决策**：所有表使用 UUID 作为主键；自然键（如 `feedUrl`、`key`）仅用于唯一索引去重。
- **理由**：全局唯一性、同步就绪、身份稳定。
- **影响**：Schema 变更需清库（首发策略）。

## D002 — 直接使用 i18n
- **决策**：组件直接使用 `react-i18next` 的 `useTranslation()`；不保留 `useI18n` 适配层。
- **理由**：标准 API、减少层级、降低理解成本。

## D003 — 离线策略 A
- **决策**：离线时隐藏远程 Discovery 与远程搜索结果；保留本地内容，并展示离线徽章。
- **理由**：体验可预期，避免失败请求。

## D004 — ObjectURL 归属
- **决策**：音频 Object URL 由 Store 管理；图片 Object URL 由组件管理并在卸载时回收。
- **理由**：防止音频内存泄漏，同时保持封面渲染灵活性。

## D005 — 部署目标
- **决策**：主部署目标为 Vercel；同时支持 Docker 自托管。
- **理由**：快速上线 + 可移植备选方案。

## D006 — 法律页面要求
- **决策**：生产环境必须提供隐私政策与服务条款页面。
- **理由**：合规与上架审核要求。

## D007 — Smoke E2E 测试
- **决策**：发布前必须保留 Playwright 核心路径烟雾测试。
- **理由**：防止单测无法覆盖的端到端回归。

## D008 — 严格 CSP
- **决策**：所有 Web 部署必须启用严格的 Content Security Policy。
- **理由**：降低 XSS 与不可信资源加载风险。

## D009 — 数据保留策略
- **决策**：播放历史需按时间与数量进行裁剪。
- **理由**：避免 IndexedDB 长期膨胀造成性能劣化。

## D010 — PWA 更新生命周期
- **决策**：发现新版本时提示用户刷新并更新。
- **理由**：避免客户端长期停留旧版本。

## D011 — CI 流水线
- **决策**：每次 PR 必须通过 lint/typecheck/tests。
- **理由**：防止回归绕过本地检查。

## D012 — 导入完整性校验
- **决策**：导入前必须检查 ID 冲突与断裂引用。
- **理由**：避免 Vault/OPML 导入后静默损坏。

## D013 — 包体积预算
- **决策**：在 CI 中强制包体积预算。
- **理由**：防止依赖膨胀导致性能退化。

## D014 — Iframe Sandbox 策略
- **决策**：对不可信富文本使用严格 iframe sandbox。
- **理由**：在 DOMPurify 之外提供隔离。

## D015 — 反馈闭环
- **决策**：在应用内提供反馈入口（Issue/Email）。
- **理由**：形成产品闭环。

## D016 — 离线内容可视化
- **决策**：显示离线标识并提供缓存清理工具。
- **理由**：离线能力需可见、可管理。

## D017 — 单集排序与筛选
- **决策**：提供单集列表的排序/筛选。
- **理由**：提升规模化可发现性。

## D018 — 内容归属声明
- **决策**：提供内容归属声明与版权申诉入口。
- **理由**：降低法律风险。

## D019 — 多语言排版规范
- **决策**：为不同语言指定字体栈。
- **理由**：保证不同脚本一致性。

## D020 — DB 访问防护
- **决策**：禁止 UI 组件直接访问数据库层。
- **理由**：保持架构边界。

## D021 — MSW 网络测试
- **决策**：使用 MSW 模拟外部 API。
- **理由**：稳定、可重复的测试环境。

## D022 — 贡献指南与宣言
- **决策**：编写 CONTRIBUTING 与架构宣言。
- **理由**：降低新成员上手成本。

## D023 — PWA 音频 Range 缓存
- **决策**：在 SW 中支持 Range 请求 (206) 以实现离线 seek。
- **理由**：保证大音频文件可离线跳转。

## D024 — 内存压测
- **决策**：维护长会话内存压测流程。
- **理由**：避免长时间播放导致移动端崩溃。

## D025 — 代理故障转移
- **决策**：支持代理列表与自动切换（429/5xx）。
- **理由**：代理失效时保持探索可用。

## D026 — I18n 覆盖审计
- **决策**：构建时强制多语言 key 对齐。
- **理由**：避免非英文缺失 key。

## D027 — IndexedDB 迁移
- **决策**：从清库策略升级为版本化迁移。
- **理由**：生产环境保留用户数据。

## D028 — 浏览器支持矩阵
- **决策**：配置 browserslist 与兼容策略。
- **理由**：避免旧设备白屏。

## D029 — Turborepo 缓存加固
- **决策**：明确 Turbo inputs/outputs。
- **理由**：提升 CI 可靠性与速度。

## D030 — 原子写入与自愈
- **决策**：复合写入必须事务化，并在启动时自愈。
- **理由**：防止断电导致半损坏。

## D031 — 异步竞态防护
- **决策**：requestId/AbortController 保证最后一次点击生效。
- **理由**：防止播放与 UI 状态错位。

## D032 — 元数据解析器升级
- **决策**：使用 `music-metadata-browser` + Worker 解析 ID3。
- **理由**：降低解析错误并保持主线程顺滑。

## D033 — 骨架屏系统
- **决策**：统一 Shimmer 骨架用于关键页面。
- **理由**：减少布局抖动，提升感知性能。

## D034 — 覆盖层分层标准化
- **决策**：统一 Portal 与 z-index tokens，不引入全局模态状态。
- **理由**：避免层级冲突，同时保留局部状态。

## D035 — 媒体缓存淘汰
- **决策**：引入 LRU 音频缓存淘汰策略（可配置上限）。
- **理由**：防止存储无限膨胀。

## D036 — 网络退避与断路器
- **决策**：加入指数退避与代理断路器。
- **理由**：避免重试风暴，提高代理稳定性。

## D037 — 存储配额监控
- **决策**：在 Settings 显示配额使用并预警。
- **理由**：在存储耗尽前给用户可见性。

## D038 — Intl API 格式化升级
- **决策**：日期、数字、相对时间统一使用 Intl API。
- **理由**：提升多语言正确性并减少手写逻辑。

## D039 — 细粒度错误边界
- **决策**：关键组件使用局部 Error Boundary。
- **理由**：避免单点崩溃影响整页。

## D040 — Lighthouse CI 预算
- **决策**：CI 中强制 Lighthouse 指标阈值。
- **理由**：防止性能与无障碍回退。

## D041 — 依赖审计与许可证策略
- **决策**：CI 中强制漏洞与许可证检查。
- **理由**：降低供应链与合规风险。

## D042 — 浮动 Promise 审计
- **决策**：异步 store 操作必须显式处理错误。
- **理由**：防止静默失败和状态不一致。

## D043 — 事件监听泄漏审计
- **决策**：使用统一 hook 管理全局监听。
- **理由**：避免长会话内存泄漏。

## D044 — Zustand 选择器优化
- **决策**：强制原子选择器与 `useShallow` 多字段选择。
- **理由**：减少无关重渲染。

## D045 — RSS 内容 CSS 隔离
- **决策**：show-notes 采用 scoped reset（必要时用 Shadow DOM）。
- **理由**：防止不可信 HTML 污染 UI。

## D046 — 文件校验策略
- **决策**：采用分层策略兼顾性能与安全。
  - **Web (Lite)**：仅做 MIME 类型 + 扩展名校验（侧重体验）。
  - **后端**：进行内容深度校验（Magic number 或完整解析）。
  - **Native**：依赖解码器校验或导入时的轻量头部检查。
- **理由**：保持客户端逻辑轻量、快速，同时将高强度安全检查推迟到受控的安全环境中。

## D047 — UI 模式变更门控
- **决策**：凡在 `ui-patterns/*.mdx` 中新增的标准化交互（如标准表单、文件拖拽区域）必须同步记录至决策日志。
- **理由**：确保架构一致性，并为跨项目的 UI 标准化提供事实依据（指令 012-015）。

## D048 — 标准化文件拖拽区域
- **决策**：所有文件上传界面必须使用基于 `react-dropzone` 并结合 Zod 校验的 `FileDropZone` 组件。
- **理由**：在整个应用中提供一致的视觉反馈（毛玻璃效果）、集中的错误处理和类型安全的校验（指令 015）。

## D049 — 高级玻璃拟态视觉
- **决策**：核心结构化界面（侧边栏、播放器页脚、遮罩层）必须使用高级玻璃材质（`backdrop-blur-xl`, `backdrop-saturate-150` 以及 `bg-background/80` 或 `bg-popover/95`）。
- **理由**：实现高质量、类原生应用的视觉美感，同时保持内容的自适应性、主题协调性以及清晰度（指令 016）。

## D050 — 列表行交互规范
- **决策**：所有列表项（Rows）和卡片必须使用 `bg-accent/50` 作为悬停状态，并使用 `border-border/50` 进行视觉分隔，同时配合“智能分隔线”逻辑（指令 016）。
- **理由**：确保不同任务场景下列表布局的一致性，并为交互项创造出聚焦的“浮动”视觉效果。

## D051 — 现代 Toast 通知系统 (Sonner)
- **决策**：将 Radix Toast 替换为 `sonner` 作为全站的通知反馈方案。
- **理由**：Sonner 提供了更优的开发体验（命令式 API）、更好的视觉堆叠效果、内置的 Promise 支持以及类原生应用的流畅动画（指令 017）。

## D052 — 命令面板搜索 (cmdk)
- **决策**：将自定义的悬浮搜索遮罩 (Search Overlay) 替换为基于 `cmdk` 的侧边栏内嵌式命令面板 (`CommandPalette`)。
- **理由**：提供一致的键盘导航支持、更佳的无障碍体验，以及全局可用的现代"侧边栏内嵌式搜索体验"（指令 018）。

## D053 — 标准化徽章系统
- **决策**：列表和命令面板中的所有状态指示符（订阅、收藏、历史记录、文件、稍后收听）必须使用统一的视觉语言：右对齐、垂直居中、`text-primary` 颜色。
- **理由**：通过为整个应用程序的"状态"元数据建立可预测的位置和颜色，确保视觉一致性并减少认知负荷。

## D055 — 标准化 Bits 动画
- **决策**：在 `src/components/bits/` 中引入一套标准化、高质量的动画组件 (Bits)，首批包含 `AnimatedList` 和 `CountUp`。
- **理由**：通过流体、高级的动效模式 (Framer Motion) 提升应用的“感官品质 (Vibe)”和感知质量，同时确保复用性与架构一致性（指令 021）。
- **实现**：
    - `AnimatedList`: 为列表和网格提供交错入场动画。
    - `CountUp`: 为统计数据和用量数值提供平滑的弹簧数值转换。

## D056 — 条件式“最近播放”时间戳更新
- **决策**：`PlaybackSession` 中的 `lastPlayedAt` 时间戳仅在 `isPlaying` 为 true 时更新。
- **理由**：防止会话恢复（如重新打开标签页）或在暂停时手动跳转进度错误地将项目推至“最近”列表顶部。“最近播放”应在语义上代表对内容的活跃消费。
- **实现**：
    - 移除了 `DB.updatePlaybackSession` 中的强制 `Date.now()`。
    - `playerStore` 的 Action（`updateProgress`、`saveProgressNow`）根据当前 `isPlaying` 状态有条件地包含 `lastPlayedAt`。

## D057 — 共享元素转换 (Shared Element Transitions)
- **决策**：使用 `layoutId` (Framer Motion) 同步全局 UI 状态（MiniPlayer <-> FullPlayer）之间的持久性 UI 元素（特别是封面图）。
- **理由**：保持空间连续性，减少视觉上的“突跳”感，实现高端类原生的应用体验。
- **约束**：`layoutId` 在同一个可见 tree 中必须唯一。如果移动端/桌面端布局中的多个节点追踪同一个语义对象，必须使用条件渲染（如 `isDesktop` 判断）确保同一时间只有一个节点持有该 ID。

## D058 — 应用启动序列 (App Boot Sequence)
- **决策**：在所有核心 IndexedDB 存储完成水合 (Hydration) 且播放器会话恢复完成之前，显示全屏 `BootLoader`（呼吸动画 Logo）。
- **理由**：防止“水合闪烁”（空状态短暂过渡），并为冷启动提供高级的类原生应用体验。
- **约束**：
    - 加载器必须使用 `fixed inset-0 z-50 bg-background` 以完美覆盖内容。
    - 必须使用 `AnimatePresence` 实现平滑淡出转场。
