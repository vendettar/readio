# Code Audit & Improvement Manual

This document defines how the agent must perform a **strict, structured code audit**
after completing an implementation task.

This document is used **only after task completion**.
It does NOT define how to build features, only how to review them.

This repo also has a separate audit mode entrypoint:
- `docs/audit_system.md` (strict audit mode guardrails + mandatory output format)

When both documents apply:
- Use `docs/audit_system.md` as the top-level "rules of engagement"
- Use this document for detailed procedure and checklists

---

## 0. Purpose of Audit Mode

Audit mode exists to:
- Prevent long-term code decay
- Enforce design system and architectural rules
- Catch violations early, before they spread

This is a **review-only mode**.

The agent must evaluate, not create.

---

## 1. Audit Role & Responsibility

When this document is active, the agent acts as a **senior reviewer**, not an implementer.

The agent must:
- Review existing code objectively
- Identify rule violations and structural risks
- Propose minimal, actionable improvements

The agent must NOT:
- Implement changes
- Rewrite large portions of code
- Speculate about future features or requirements

System integrity has higher priority than local optimization.

---

## 2. Audit Scope

- Review **only** code that was added or modified in the most recent task
- If the user explicitly requests a full-repo audit, you MAY audit the entire repo
- Ignore untouched files (unless full-repo audit is explicitly requested)
- Ignore unrelated systems or future concerns

If the scope is unclear, ask for clarification before reviewing.

### 2.1 How to determine scope (this repo)

Preferred scope inputs (in priority order):
1) User-provided commit range (`A..B`) → audit exactly that range
2) Latest commit only → `git show --name-only -1`
3) Latest commit + local changes → `git show --name-only -1` + `git status --porcelain`

Generated files:
- `src/routeTree.gen.ts` is generated by the TanStack Router plugin; audit only for correctness signals.

---

## 3. Audit Priority Order (Mandatory)

All findings must follow the priority order below.
Lower-priority concerns must never override higher-priority rules.

---

### 3.1 Design System & Rule Compliance (Highest Priority)

Strictly verify against the project design system and frontend rules.

Check for:
- Invented colors, spacing, typography, or visual styles
- Incorrect or missing usage of Tailwind CSS
- Bypassing shadcn/ui components when applicable
- Unnecessary raw or global CSS
- CSS that violates component-scoping rules

If violations exist:
- Explicitly label them as **SYSTEM VIOLATIONS**
- Explain why they violate the system
- Propose the **minimal** change required to fix them

---

### 3.2 Architecture & Structure

Evaluate:
- Component responsibility boundaries
- Atomic structure (atoms → components → sections)
- Reusability versus duplication
- Naming clarity and file organization

Flag:
- Overloaded components
- UI components containing excessive logic
- Premature or unnecessary abstractions

Do NOT recommend architectural changes unless a clear problem exists.

---

### 3.3 Code Quality & Maintainability

Check for:
- Readability and clarity
- Unnecessary complexity
- Repeated patterns that reduce maintainability
- Props or state that can be simplified

Avoid:
- Style-only refactors
- Preference-based or subjective suggestions

---

### 3.4 Performance & Correctness (Only If Real)

Comment only on:
- Clear bugs
- Obvious unnecessary re-renders
- Incorrect effects or dependency arrays

Do NOT:
- Invent hypothetical performance problems
- Optimize without evidence

---

## 4. Improvement Rules

All improvement suggestions must:
- Be **minimal and targeted**
- Clearly explain **WHY** the change matters
- Clearly explain **WHAT** should change

Do NOT:
- Suggest large rewrites
- Suggest changing libraries, frameworks, or architecture
- Suggest style changes that violate the design system

The goal is correction, not perfection.

---

## 5. Review Output Format (Mandatory)

The audit result must be returned using the following structure:

## Summary
- 2–5 bullets: what is good, what is risky, what is next

## Critical Issues
- Only SYSTEM VIOLATIONS or correctness bugs
- Each item must include:
  - Where (file path + symbol/component name)
  - Why it matters (user impact or system rule)
  - Minimal fix direction (no large rewrites)

## Improvement Suggestions
- Non-critical, high ROI cleanups
- Must be actionable and justified

## Optional Refactors
- Clearly marked as non-blocking
- Only include if it reduces future maintenance cost

## Verification Checklist
- `npm run test:run`
- `npm run build`
- (If routing touched) manual: back/forward, open/close `/explore` and `/files`, playback not interrupted

### 5.0 Project-Specific Review Checklist (Readio)

- Playback continuity: `<audio>` remains mounted at root; routing/UI updates must not interrupt audio.
- Interaction rules: no nested interactives; no full-card overlays; all interactivity uses shadcn/ui (`Button`/`asChild`).
- i18n: all user-facing strings must use `t(key)`; new keys must be added to all languages.
- Inline styles: only allowed for CSS variables, virtualization, or cursor-positioned popups; otherwise forbidden.
- Explore rules: no in-page search; no “Trending/Hot” sections.
- Files rules: single-level folders; density toggle; view controls bar; rename conflicts handled.
- Dropdown/Popover: premium overlay styling and propagation rules consistent.

### 5.1 Documentation rule (mandatory)

After any improvement work is accepted/applied:
- Update `docs/handoff_doc.md` to match actual code state (results only).
